<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Player | AxonFlow Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/firestore-manager.js"></script>
    <script src="js/ai-teacher-agent.js"></script>
    <script src="js/subscription-manager.js"></script>
    <script src="js/global-auth.js"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-slate-900 border-b border-slate-800 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="my-courses.html" class="text-cyan-400 hover:underline">‚Üê Back to My Courses</a>
            <h1 id="course-title" class="text-xl font-bold"></h1>
            <div id="user-info" class="flex items-center space-x-3"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar - Modules -->
        <div class="lg:col-span-1 bg-slate-900 rounded-xl p-4 h-fit">
            <h2 class="text-xl font-bold mb-4">üìö Course Content</h2>
            <div id="modules-list" class="space-y-2"></div>
            <div class="mt-6 pt-4 border-t border-slate-800">
                <div class="text-sm text-gray-400 mb-2">Progress</div>
                <div class="bg-slate-800 rounded-full h-2 mb-2">
                    <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-cyan-500 h-2 rounded-full transition-all" style="width:0%"></div>
                </div>
                <div id="progress-text" class="text-sm text-cyan-400">0% Complete</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="lg:col-span-3 space-y-6">
            <!-- Content Player -->
            <div class="bg-slate-900 rounded-xl p-6">
                <div id="content-area" class="min-h-[400px]">
                    <div class="flex items-center justify-center h-96 bg-slate-800 rounded-lg">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üéì</div>
                            <p class="text-gray-400">Select a module to start learning</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Teacher -->
            <div class="bg-gradient-to-r from-purple-900/30 to-cyan-900/30 border border-purple-500/30 rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold mb-2">ü§ñ Need Help?</h3>
                        <p class="text-gray-300">Ask our AI Teacher anything about this course</p>
                    </div>
                    <button onclick="openAITeacher()" class="bg-purple-500 text-white px-6 py-3 rounded-xl hover:bg-purple-600 font-bold transition">
                        Open AI Teacher
                    </button>
                </div>
            </div>

            <!-- Assignment Submission -->
            <div class="bg-slate-900 rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4">üìã Submit Assignment</h3>
                <form id="assignment-form" class="space-y-4">
                    <input type="text" id="assignment-title" placeholder="Assignment Title" class="w-full bg-slate-800 text-white rounded-lg px-4 py-3 border border-slate-700 focus:border-cyan-500 focus:outline-none" required>
                    <textarea id="assignment-description" placeholder="Describe your work..." rows="4" class="w-full bg-slate-800 text-white rounded-lg px-4 py-3 border border-slate-700 focus:border-cyan-500 focus:outline-none" required></textarea>
                    <input type="url" id="assignment-link" placeholder="Project Link (GitHub, Live Demo, etc.)" class="w-full bg-slate-800 text-white rounded-lg px-4 py-3 border border-slate-700 focus:border-cyan-500 focus:outline-none">
                    <button type="submit" class="bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 font-bold transition">Submit Assignment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Teacher Modal -->
    <div id="ai-teacher-modal" class="hidden fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4">
        <div class="bg-slate-900 rounded-2xl w-full max-w-4xl h-[85vh] flex flex-col border border-purple-500/30">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-cyan-600 p-4 flex justify-between items-center rounded-t-2xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center animate-pulse">
                        <span class="text-2xl">ü§ñ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">AI Teacher</h3>
                        <p class="text-xs text-purple-100" id="ai-model-info">Gemini Pro</p>
                    </div>
                </div>
                <button onclick="closeAITeacher()" class="text-white hover:text-gray-200 text-3xl font-bold">&times;</button>
            </div>

            <!-- Chat Area -->
            <div id="chat-area" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-800">
                <div class="bg-purple-500/20 border border-purple-500/30 rounded-xl p-4">
                    <p class="text-white font-medium mb-2">üëã Hello! I'm your AI Teacher!</p>
                    <p class="text-gray-300 text-sm">Ask me anything about this course. I'm here to help you learn!</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-slate-700 bg-slate-900 rounded-b-2xl">
                <div id="message-limit-info" class="text-sm text-gray-400 mb-2"></div>
                <div class="flex space-x-3">
                    <input type="text" id="ai-input" placeholder="Ask anything about this course..." 
                        class="flex-1 bg-slate-800 text-white rounded-xl px-4 py-3 border border-slate-600 focus:border-purple-500 focus:outline-none"
                        onkeypress="if(event.key==='Enter') sendAIMessage()">
                    <button onclick="sendAIMessage()" class="bg-gradient-to-r from-purple-500 to-cyan-500 text-white font-semibold px-8 py-3 rounded-xl hover:shadow-lg transition">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCourse = null;
        let currentUser = null;
        let aiTeacher = null;
        let modules = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = JSON.parse(localStorage.getItem('axonflow_user'));
            if (!currentUser) {
                window.location.href = 'academy.html';
                return;
            }

            // Display user info
            document.getElementById('user-info').innerHTML = `
                <img src="${currentUser.avatar}" alt="Avatar" class="w-8 h-8 rounded-full">
                <div class="text-sm">
                    <div class="font-medium">${currentUser.name}</div>
                    <div class="text-gray-400 text-xs">${currentUser.email}</div>
                </div>
                <button onclick="globalAuth.signOut()" class="text-red-400 hover:text-red-300 text-sm">Sign Out</button>
            `;

            // Get course ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');

            if (!courseId) {
                window.location.href = 'my-courses.html';
                return;
            }

            // Load course data
            await loadCourse(courseId);
        });

        async function loadCourse(courseId) {
            try {
                // Get course from Firestore or use production modules
                currentCourse = await window.firestoreManager?.getCourse(courseId) || {
                    id: courseId,
                    name: 'React.js Complete Course',
                    description: 'Master React.js from basics to advanced'
                };

                document.getElementById('course-title').textContent = currentCourse.name;

                // Load modules
                modules = window.getCourseModules ? window.getCourseModules(courseId).modules : [
                    {id: 1, title: 'Introduction to React', duration: '2h', topics: ['What is React?', 'JSX', 'Components']},
                    {id: 2, title: 'State & Props', duration: '3h', topics: ['useState', 'Props', 'State Management']},
                    {id: 3, title: 'Hooks', duration: '4h', topics: ['useEffect', 'useContext', 'Custom Hooks']},
                    {id: 4, title: 'React Router', duration: '3h', topics: ['Routing', 'Navigation', 'Dynamic Routes']},
                    {id: 5, title: 'Final Project', duration: '5h', topics: ['Build App', 'Deploy', 'Best Practices']}
                ];

                renderModules();
                updateProgress();
            } catch (e) {
                console.error('Load course error:', e);
            }
        }

        function renderModules() {
            const modulesList = document.getElementById('modules-list');
            const completedModules = JSON.parse(localStorage.getItem(`completed_${currentCourse.id}`) || '[]');

            modulesList.innerHTML = modules.map(module => {
                const isCompleted = completedModules.includes(module.id);
                return `
                    <div onclick="loadModule(${module.id})" class="p-3 rounded-lg cursor-pointer transition-all ${isCompleted ? 'bg-green-900/30 border border-green-500/30' : 'bg-slate-800 hover:bg-slate-700'} border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${module.title}</div>
                                <div class="text-xs text-gray-400">${module.duration}</div>
                            </div>
                            ${isCompleted ? '<span class="text-green-400 text-xl">‚úì</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadModule(moduleId) {
            const module = modules.find(m => m.id === moduleId);
            if (!module) return;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold">${module.title}</h2>
                    <div class="bg-slate-800 rounded-lg p-8">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">üìö</div>
                            <p class="text-xl text-gray-300 mb-2">Module ${module.id}: ${module.title}</p>
                            <p class="text-sm text-gray-400">Duration: ${module.duration}</p>
                        </div>
                        
                        <div class="bg-slate-700 rounded-lg p-6 mb-6">
                            <h3 class="font-bold text-lg mb-3">Topics Covered:</h3>
                            <ul class="space-y-2">
                                ${module.topics.map(topic => `<li class="flex items-center space-x-2"><span class="text-cyan-400">‚ñ∏</span><span>${topic}</span></li>`).join('')}
                            </ul>
                        </div>

                        <div class="flex justify-center">
                            <button onclick="completeModule(${module.id})" class="bg-gradient-to-r from-purple-500 to-cyan-500 text-white px-8 py-3 rounded-xl font-bold hover:shadow-lg transition">
                                Mark as Complete
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-500/20 border border-purple-500/30 rounded-lg p-4">
                        <p class="text-sm text-purple-200">üí° Tip: Use the AI Teacher if you have questions about this module!</p>
                    </div>
                </div>
            `;
        }

        function completeModule(moduleId) {
            const completedModules = JSON.parse(localStorage.getItem(`completed_${currentCourse.id}`) || '[]');
            if (!completedModules.includes(moduleId)) {
                completedModules.push(moduleId);
                localStorage.setItem(`completed_${currentCourse.id}`, JSON.stringify(completedModules));
            }
            renderModules();
            updateProgress();
            showNotification('‚úÖ Module completed!');
        }

        function updateProgress() {
            const completedModules = JSON.parse(localStorage.getItem(`completed_${currentCourse.id}`) || '[]');
            const progress = Math.round((completedModules.length / modules.length) * 100);
            
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '% Complete';
        }

        // AI Teacher Functions
        async function openAITeacher() {
            if (!window.AITeacherAgent) {
                showNotification('‚ùå AI Teacher not available. Please refresh the page.');
                return;
            }

            document.getElementById('ai-teacher-modal').classList.remove('hidden');
            
            if (!aiTeacher) {
                aiTeacher = new window.AITeacherAgent();
                await aiTeacher.initialize(currentUser.id, currentCourse.id);
                
                // Update model info
                const subscription = await window.firestoreManager?.getUserSubscription(currentUser.id) || {tier: 'Free'};
                document.getElementById('ai-model-info').textContent = `${aiTeacher.getModel()} ‚Ä¢ ${subscription.tier} Tier`;
                
                // Show message limit for Free tier
                if (subscription.tier === 'Free') {
                    document.getElementById('message-limit-info').textContent = `${subscription.messagesUsed || 0}/${subscription.messagesLimit || 5} messages used today`;
                }
            }
        }

        function closeAITeacher() {
            document.getElementById('ai-teacher-modal').classList.add('hidden');
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            // Send to AI
            const result = await aiTeacher.sendMessage(currentUser.id, message);
            
            // Remove typing indicator
            document.getElementById(typingId)?.remove();

            if (result.error) {
                addChatMessage(result.error, 'error');
                if (result.error.includes('limit')) {
                    setTimeout(() => {
                        window.subscriptionManager?.showUpgradeModal('Free');
                    }, 2000);
                }
            } else {
                addChatMessage(result.response, 'ai');
                
                // Update message count
                const subscription = await window.firestoreManager?.getUserSubscription(currentUser.id);
                if (subscription?.tier === 'Free') {
                    document.getElementById('message-limit-info').textContent = `${subscription.messagesUsed || 0}/${subscription.messagesLimit || 5} messages used today`;
                }
            }
        }

        function addChatMessage(text, sender) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';
            
            if (sender === 'user') {
                div.innerHTML = `<div class="bg-cyan-500 text-white rounded-xl px-4 py-3 max-w-[70%]"><p class="text-sm whitespace-pre-line">${text}</p></div>`;
            } else if (sender === 'error') {
                div.innerHTML = `<div class="bg-red-500/20 border border-red-500 text-red-300 rounded-xl px-4 py-3 max-w-[80%]"><p class="text-sm">${text}</p></div>`;
            } else {
                div.innerHTML = `<div class="bg-purple-500/20 border border-purple-500/30 rounded-xl p-4 max-w-[80%]"><div class="flex items-start space-x-3"><span class="text-xl">ü§ñ</span><div class="text-gray-200 text-sm whitespace-pre-line">${text}</div></div></div>`;
            }
            
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function addTypingIndicator() {
            const chatArea = document.getElementById('chat-area');
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex justify-start';
            div.innerHTML = '<div class="bg-purple-500/20 rounded-xl px-4 py-3"><div class="flex space-x-1"><div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div><div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div></div></div>';
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
            return id;
        }

        // Assignment Submission
        document.getElementById('assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                title: document.getElementById('assignment-title').value,
                description: document.getElementById('assignment-description').value,
                link: document.getElementById('assignment-link').value,
                courseId: currentCourse.id,
                userId: currentUser.id,
                submittedAt: new Date().toISOString()
            };

            // Save to Firestore or localStorage
            const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
            assignments.push(data);
            localStorage.setItem('assignments', JSON.stringify(assignments));

            showNotification('‚úÖ Assignment submitted successfully!');
            e.target.reset();
        });

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
</body>
</html>
